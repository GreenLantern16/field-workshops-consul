name: Chapter-5
class: center,middle
.section[
Chapter 5  
Service Discovery
]

---
name: Service-Discovery-Intro
Service Discovery - Intro
-------------------------
<br><br>
<img align="right" width="40%" src="images/service_registration_catalog.png">

The starting point for networking with Consul is typically a common service registry. This would integrate health checks and provide DNS and API interfaces to enable any service to discover and be discovered by other services.

Consul can be integrated with other services that manage existing north-south traffic such as a traditional load balancers, and distributed application platforms such as Kubernetes, to provide a consistent registry and discovery service across multi-data center, cloud, and platform environments.

---
name: Service-Discovery-Lab-Servers
Service Discovery - Servers
-------------------------
<br><br>
<img align="right" width="50%" src="images/consul_dataflow_lan.png">

Consul's service discovery is backed by a service catalog. This catalog is formed by aggregating information submitted by the agents. The catalog maintains the high-level view of the cluster, including which services are available, which nodes run those services, health information, and more. The catalog is used to expose this information via the various interfaces Consul provides, including DNS and HTTP.

Services and checks within the context of the catalog have a much more limited set of fields when compared with the agent. This is because the catalog is only responsible for recording and returning information about services, nodes, and health.

The catalog is maintained only by server nodes. This is because the catalog is replicated via the Raft log to provide a consolidated and consistent view of the cluster.

---
name: Service-Discovery-Lab-Clients
Service Discovery - Clients
-------------------------
<br><br>
<img align="right" width="40%" src="images/consul_health_checks.png">

Each Consul agent maintains its own set of service and check registrations as well as health information. The agents are responsible for executing their own health checks and updating their local state.

Services and checks within the context of an agent have a rich set of configuration options available. This is because the agent is responsible for generating information about its services and their health through the use of health checks:

* Clients check local services
* Node health checked via gossip
* Only state changes sent to servers
* Service discovery filters on health
* Check types - HTTP, TCP, scripts, etc.

---
name: Service-Discovery-Registration
Service Discovery - Config
-------------------------
.center[![:scale 45%](images/nginx_service_definition.png)]
.center[Nginx example] <br>

---
name: Service-Registry-API
Service Registry - API Interface
-------------------------
.center[![:scale 45%](images/service_registry_api.png)]
.center[API Catalog Request] <br>

---
name: Service-Registry-DNS
Service Registry - DNS Interface
-------------------------
.center[![:scale 45%](images/service_registry_dns.png)]
.center[DNS Catalog Request] <br>

---
name: Service-Registry-UI
Service Registry - UI Interface
-------------------------
.center[![:scale 60%](images/service_registry_ui.png)]
.center[UI Catalog Request] <br>

---
name: Service-Registry-Integration-Consul-Template
Integrations - Consul Template
-------------------------
<br><br>
<img align="right" width="40%" src="images/consul_template_example.png">

Consul Template is a standalone application that populates values from Consul and dynamically renders updates to any third party configurations.  

A common use case is managing load balancer configuration files that need to be updated regularly in a dynamic infrastructure on machines many not be able to directly connect to the Consul cluster.

It is an ideal for replacing complicated API queries that often require custom formatting. The template tool is based on Go templates and shares many of the same attributes.

---
name: Service-Registry-Integration-DNS
Integrations - DNS
-------------------------
<br><br>
<img align="right" width="40%" src="images/consul_example_dns.png">

 Using DNS is a simple way to integrate Consul into an existing infrastructure without any high-touch integration:

* Zero-touch
* Round robin load balancing
* Unhealthy instances are automatically filtered out

---
name: Service-Registry-Integration-Native
Integrations - API/Native
-------------------------
<br><br>
<img align="right" width="40%" src="images/consul_ecosystem_diagram.png">

By leveraging Consul‚Äôs RESTful HTTP API system, the community and vendors are able to integrate with Consul's service registry capabilities.

These integrations include load balancers, proxies, API gateways, monitoring tools, and more!

---
name: Service-Registry-Integration-Native
Example - Native Consul Integration with F5 BIG-IP
-------------------------
<br><br>
<img align="right" width="60%" src="images/f5_consul_integration.png">

The F5 BIG-IP AS3 service discovery integration with Consul queries Consul's catalog on a regular, configurable basis to get updates about changes for a given service, and adjusts the node pools dynamically without operator intervention.

.center[
<a href="https://www.hashicorp.com/resources/zero-touch-application-delivery-with-f5-big-ip-terraform-and-consul" target=_blank>HashiCorp F5 Consul Webinar</a>
]

.center[
<a href="https://github.com/hashicorp/f5-terraform-consul-sd-webinar" target=_blank>Webinar Demo Repo</a>
]

.center[
<a href="https://clouddocs.f5.com/products/extensions/f5-appsvcs-extension/latest/declarations/discovery.html#service-discovery-using-hashicorp-consul" target=_blank>F5 Consul Docs</a>
]

---
name: Service-Discovery-Lab
.center[.lab-header[üë©üèΩ‚Äçüíª Lab Exercise: Service Discovery]]
<br><br><br>
.blocklist[
You will accomplish the following in this lab:

* Service Registration
* Health Checks
* Service Discovery
* Automated Config Management
* Seamless DNS integration
]

### .center[<a href="https://instruqt.com/hashicorp/tracks/service-discovery-with-consul" target="_blank">Instruqt - Consul Service Discovery</a>]
