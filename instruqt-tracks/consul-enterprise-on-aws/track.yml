slug: consul-enterprise-on-aws
id: uyhpz2gmcv6f
type: track
title: Consul Enterprise on AWS
teaser: A short description of the track.
description: |-
  A long description of the track.

  You can use any GitHub flavoured markdown.
icon: https://storage.googleapis.com/instruqt-frontend/img/tracks/default.png
tags: []
owner: hashicorp
developers:
- lance@hashicorp.com
private: true
published: true
challenges:
- slug: provision-vpcs
  id: zf9q5j426xdi
  type: challenge
  title: 'Infrastructure: Provision VPCs'
  teaser: A short description of the challenge.
  assignment: |-
    The cloud infrastructure team is responsible for providing VPCs to shared service and development teams.
    You can think of workstation terminal as your laptop machine preloaded with cloud access credentials for your company. <br>

    Any any time you can use the AWS console to view your environment.
    AWS CLI commands will be provided for you to interact with AWS's APIs. <br>


    Inspect the Terraform code, and then provision the cloud environment.

    ```
    terraform apply -auto-approve
    ```

    You'll notice you have four separate VPCs that map to the infra diagram shared earlier.

    ```
    aws ec2 describe-vpcs
    ```

    Their CIDR blocks are listed below:

    ```
    terraform-vpc-shared-svcs: 10.1.0.0/16
    terraform-vpc-frontend: 10.2.0.0/16
    terraform-vpc-api: 10.3.0.0/16
    terraform-vpc-storage: 10.4.0.0/16
    ```

    Our shared service VPC will run the core Consul infrastructure.
    You will provision the Consul servers in the next assignment.
  notes:
  - type: text
    contents: |-
      In this assignment you will familiarize yourself with the AWS cloud
      environment. <br>

      Please be patient as we provision your cloud environment in AWS.
  tabs:
  - title: Terraform
    type: code
    hostname: cloud-client
    path: /root/terraform/infra
  - title: Cloud CLI
    type: terminal
    hostname: cloud-client
  - title: Cloud Consoles
    type: service
    hostname: cloud-client
    path: /
    port: 80
  difficulty: basic
  timelimit: 3000
- slug: build-consul-image
  id: gudhtmhdc2au
  type: challenge
  title: 'Operations: Build Consul Image'
  teaser: A short description of the challenge.
  assignment: |-
    In this assignment you will build an immutable image of [Consul with HashiCorp Packer](https://packer.io/) <br>

    Immutability has many advantages for infrastructure management.
    Consul enterprise can take advantage of immutable patterns with [Automated Upgrades](https://www.consul.io/docs/enterprise/upgrades/index.html)

    The Packer build has been set up for you. Inspect the variable file, then build the image.

    ```
    cat /root/packer/vars.json
    AWS_REGION=us-east-1 packer build -var-file vars.json centos.json
    ```

    Validate your AMI is available in us-east-1.

    ```
    aws ec2 describe-images --owners self
    ```

    Now that you have a Consul image, you're ready to provision Consul in a prod-like ASG.
  notes:
  - type: text
    contents: Replace this text with your own text
  tabs:
  - title: Packer
    type: code
    hostname: cloud-client
    path: /root/packer
  - title: Cloud CLI
    type: terminal
    hostname: cloud-client
  - title: Cloud Consoles
    type: service
    hostname: cloud-client
    path: /
    port: 80
  difficulty: basic
  timelimit: 3000
- slug: provision-consul
  id: lb5bfvjidxkm
  type: challenge
  title: 'Operations: Provision Consul'
  teaser: A short description of the challenge.
  assignment: |-
    In this assignment, you'll install the ASG that will run the Consul servers.
    The terraform module is configured to use the packer image you created in the last assignment. <br>

    Inspect the variable file, then deploy Consul.

    ```
    cat consul.auto.tfvars
    terraform apply -auto-approve
    ```

    Now, validate the Consul servers deployed to AWS. <br>

    ```
    aws autoscaling describe-auto-scaling-groups
    ```

    You should see the Consul servers with a ``*-0.0.1` postfix.
    You will increment the deployment in the next exercise to finish the immutable bootstrap.

    Let's inspect one of the newly provisioned Consul instances.
    We can access the newly provisioned instance through our bastion host helper script.

    ```
    check-consul-config
    ```

    Go to the next assignment, and finish the bootstrap.
  notes:
  - type: text
    contents: Replace this text with your own text
  tabs:
  - title: Terraform
    type: code
    hostname: cloud-client
    path: /root/terraform/consul
  - title: Cloud CLI
    type: terminal
    hostname: cloud-client
  - title: Cloud Consoles
    type: service
    hostname: cloud-client
    path: /
    port: 80
  difficulty: basic
  timelimit: 300
- slug: bootstrap-consul
  id: e9a2xlzwes8d
  type: challenge
  title: 'Operations: Bootstrap Consul'
  teaser: A short description of the challenge.
  assignment: |-
    Consul Enterprise supports an [upgrade pattern](https://learn.hashicorp.com/consul/day-2-operations/autopilot#upgrade-migrations) that allows operators to deploy a complete cluster of new servers,
    and safely migrate the new servers until the upgrade is complete. <br>

    In one of the terminal window, you will watch the new servers added as `non-voters`.
    Once autopilot has validated the new servers, it will safely promote them.
    You will see the old servers removed from the list.

    ```
    watch consul operator raft list-peers
    ```

    Next, validate the following two changes to the `consul.auto.tfvars file` to complete the bootstrap:
      * consul_cluster_version = "0.0.2"
      * bootstrap = false

    Now run terraform, and watch the servers automatically transition.

    ```
    cat consul.auto.tfvars
    terraform apply -auto-approve
    ```

    Nice work! You just did an automated server update with Consul enterprise. <br>

    You can now validate the changes. Notice the `node_meta` is for the `0.0.2` version of the deployment. <br>

    ```
    consul catalog nodes --detailed
    ```

    You can also see that the `default_policy` for ACLs was updated for the new value.

    ```
    check-consul-config
    ```

    Now you can start setting up the tenants for the Consul shared service consumers.
  notes:
  - type: text
    contents: Replace this text with your own text
  tabs:
  - title: Terraform
    type: code
    hostname: cloud-client
    path: /root/terraform/consul
  - title: Cloud CLI
    type: terminal
    hostname: cloud-client
  - title: Cloud CLI
    type: terminal
    hostname: cloud-client
  - title: Cloud Consoles
    type: service
    hostname: cloud-client
    path: /
    port: 80
  difficulty: basic
  timelimit: 300
- slug: create-namespaces-and-policies
  id: dqbr9fjrk1uj
  type: challenge
  title: 'Operations: Create Namespaces and Policies'
  teaser: A short description of the challenge.
  assignment: |-
    The assignment the participant needs to complete in order to proceed.

    You can use any GitHub flavoured markdown.
  notes:
  - type: text
    contents: Replace this text with your own text
  tabs:
  - title: Consul
    type: service
    hostname: cloud-client
    path: /
    port: 8080
  - title: Cloud CLI
    type: terminal
    hostname: cloud-client
  - title: Cloud Consoles
    type: service
    hostname: cloud-client
    path: /
    port: 80
  difficulty: basic
  timelimit: 300
- slug: create-vpc-peering
  id: q1iyzqw46drv
  type: challenge
  title: 'Network: Create Transitive Peering'
  teaser: A short description of the challenge.
  assignment: |-
    The assignment the participant needs to complete in order to proceed.

    You can use any GitHub flavoured markdown.
  notes:
  - type: text
    contents: Replace this text with your own text
  tabs:
  - title: Cloud CLI
    type: terminal
    hostname: cloud-client
  - title: Cloud Consoles
    type: service
    hostname: cloud-client
    path: /
    port: 80
  difficulty: basic
  timelimit: 300
- slug: provision-eks-clusters
  id: vyia9s5smay0
  type: challenge
  title: 'Infrastructure: Provision EKS clusters'
  teaser: A short description of the challenge.
  assignment: |-
    The assignment the participant needs to complete in order to proceed.

    You can use any GitHub flavoured markdown.
  notes:
  - type: text
    contents: Replace this text with your own text
  tabs:
  - title: Cloud CLI
    type: terminal
    hostname: cloud-client
  difficulty: basic
  timelimit: 300
- slug: configure-eks-clusters
  id: tgg7nqest7rm
  type: challenge
  title: 'Operations: Configure EKS clusters'
  teaser: A short description of the challenge.
  assignment: |-
    The assignment the participant needs to complete in order to proceed.

    You can use any GitHub flavoured markdown.
  notes:
  - type: text
    contents: Replace this text with your own text
  tabs:
  - title: Cloud CLI
    type: terminal
    hostname: cloud-client
  difficulty: basic
  timelimit: 300
checksum: "1892905444734826185"
